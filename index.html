<html>

<head>
    <title>Knock-o Leaf Control</title>

    <!-- Materialize Sylesheets & Javascript -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!-- Better font -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">

    <!-- JQuery... because... -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

    <!-- My Scripts -->
    <script src="js/LightControl.js"></script>

    <!-- Mobile friendly :)-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <style>
        * {
            font-family: Roboto, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .ribbon {
            width: 100%;
            height: 40vh;

            background-color: #fff;
            flex-shrink: 0;
            margin-bottom: -35vh;
        }

        label {
            color: black;
        }
    </style>
</head>

<body>
    <nav>
        <div class="nav-wrapper  cyan darken-4">
            <a href="#" class="brand-logo " style="margin-left: 10px;">Knock-o Leafs</a>
        </div>
    </nav>
    <div class="ribbon"></div>
    <!-- Leave this hidden until it works... -->
    <div class="row" style="display: none;">
        <div class="col s0 m1 l3"></div>
        <div class="col s12 m10 l6">
            <div class="card z-depth-2">
                <div class="card-content">
                    <h4>Light Setup</h4>
                    <p>
                        This area will eventually allow for setup of how the lights are displayed on your wall.
                        The general idea is:
                        <ul>
                            <li>This area will let you click to add lights only next to the first light</li>
                            <li>Clicking on a tringle will blink the actual triangle</li>
                            <li>The profiles are either saved in computers cache or on the esp somehow</li>
                        </ul>
                        The general layout will hopefully look something like:
                        <!--  <img src="example.png" /> -->
                        <br>
                        Yeah... it's really rough. This is the last thing I will work on...
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col s0 m1 l3"></div>
        <div class="col s12 m5 l3">
            <div class="card z-depth-2">
                <div class="card-content">
                    <h4>Settings</h4>
                    <h5>Basic</h5>
                    <h6>Power</h6>
                    <div class="switch">
                        <center>
                            <label>
                                Off
                                <input type="checkbox" id="on-off">
                                <span class="lever "></span>
                                On
                            </label>
                        </center>
                    </div>
                    <h6>Brightness</h6>
                    <input type="range" min="0" max="100" value="100" id="brightness" />
                    <h5>Color</h5>
                    <h6>Hue</h6>
                    <input type="range" min="0" max="360" value="360" />
                    <h6>Saturation</h6>
                    <input type="range" min="0" max="100" value="100" />
                    <h6>Value</h6>
                    <input type="range" min="0" max="100" value="100" />
                    <h6>Selected Leaf (0 is all)</h6>
                    <input type="range" min="0" max="100" value="100" id="selected-leaf" />
                </div>
            </div>
        </div>
        <div class="col s12 m5 l3">
            <div class="card z-depth-2">
                <div class="card-content">
                    <h4>Pattern</h4>
                    <label>Select Pattern</label>
                    <select class="browser-default" id="pattern">

                    </select>

                    <!-- Only show when twinkle is selected-->
                    <div class="twinkle-container">
                        <label>Select Twinkle Type</label>
                        <select class="browser-default" id="twinkle-type">

                        </select>
                    </div>

                    <!-- Only show when a color modify - able is selected -->
                    <div>
                        <label>Select Color Palette</label>
                        <select class="browser-default" id="palette">

                        </select>
                    </div>

                    <!-- Only show if "no patten" is not selected -->
                    <div>
                        <h5>Pattern Settings</h5>
                        <!-- This works for all, so never hide it :) -->
                        <h6>Speed</h6>
                        <input type="range" min="0" max="100" value="100" id="pattern-speed" />

                        <h6>Autoplay</h6>
                        <div class="switch">
                            <center>
                                <label>
                                    Off
                                    <input type="checkbox" id="autoplay-on-off">
                                    <span class="lever "></span>
                                    On
                                </label>
                            </center>
                        </div>
                        <h6>Autoplay Duration</h6>
                        <input type="range" min="0" max="100" value="100" id="autoplay-duration" />

                        <!-- Related to fire / water I think???-->
                        <div class="fire-container">
                            <h5>Extra Settings</h5>
                            <h6>Cooling</h6>
                            <input type="range" min="0" max="100" value="100" id="patten-cooling" />
                            <h6>sparking</h6>
                            <input type="range" min="0" max="100" value="100" id="pattern-sparking" />
                        </div>

                        <!-- Twinkle Settings -->
                        <div class="twinkle-container">
                            <h5>Extra Settings</h5>
                            <h6>Twinkle Speed</h6>
                            <input type="range" min="0" max="100" value="100" id="pattern-twinkle-speed" />
                            <h6>Twinkle Density</h6>
                            <input type="range" min="0" max="100" value="100" id="pattern-twinkle-density" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var curJson;
        function doneLoading(data) {
            //clear the selects (prevents wild duplication)
            $('select').find('option').remove().end();

            console.log(data);
            curJson = data;
            if (data !== undefined) {

                //Leaf selection (for colors)
                if (data.allLeafs.value == 1) {
                    data.selectedLeaf.value = 0;
                }
                $('#selected-leaf').attr({
                    "max": data.selectedLeaf.max,
                    "value": data.selectedLeaf.value
                });


                //autoplay settings
                $('#autoplay-duration').attr({
                    "max": data.autoplayDuration.max,
                    "min": data.autoplayDuration.min,
                    "value": data.autoplayDuration.value
                });
                if (data.autoplay.value == 1) {
                    $('#autoplay-on-off').prop("checked", true);
                } else {
                    $('#autoplay-on-off').prop("checked", false);
                }

                //Brightness
                $('#brightness').attr({
                    "max": 100,
                    "min": 0,
                    "value": (data.brightness.value / 255) * 100
                });

                //Cooling
                $('#patten-cooling').attr({
                    "max": data.cooling.max,
                    "min": data.cooling.min,
                    "value": data.cooling.value
                });

                //Load palettes
                $.each(data.palette.options, function (i, d) {
                    $('#palette').append('<option value="' + i + '">' + d + '</option>');
                });
                $('#palette').val(data.palette.value);
                //TODO: find out which patterns this works for, only display
                // when those patterns are active.

                //Load patterns
                var isTwinkle = false;
                $.each(data.pattern.options, function (i, d) {
                    if (d.includes("Twinkle")) {
                        if (i == data.pattern.value) {
                            isTwinkle = true;
                        }
                        $('#twinkle-type').append('<option value="' + i + '">' + d + '</option>');
                    } else {
                        $('#pattern').append('<option value="' + i + '">' + d + '</option>');
                    }
                });
                $('#pattern').append('<option value="twinkle">Twinkles...</option>');
                if (isTwinkle) {
                    $('#pattern').val("twinkle").change();
                    $('#twinkle-type').val(data.pattern.value).change();
                } else {
                    $('#pattern').val(data.pattern.value).change();
                }

                //Power
                if (data.power.value == 1) {
                    $('#on-off').prop("checked", true);
                } else {
                    $('#on-off').prop("checked", false);
                }

                //Solid color
                $('.ribbon').css("background-color", "rgb(" + data.solidColor.value + ")");
                //TODO: Convert this to HSV and setup our sliders


                //TODO: Hide this stuff when the active pattern doesn't effect it.
                //sparking
                $('#pattern-sparking').attr({
                    "max": data.sparking.max,
                    "min": data.sparking.min,
                    "value": data.sparking.value
                });

                //Speed
                $('#pattern-speed').attr({
                    "max": data.speed.max,
                    "min": data.speed.min,
                    "value": data.speed.value
                });

                //Twinkle Density
                $('#pattern-twinkle-density').attr({
                    "max": data.twinkleDensity.max,
                    "min": data.twinkleDensity.min,
                    "value": data.twinkleDensity.value
                });

                //Twinkle Speed
                $('#pattern-twinkle-speed').attr({
                    "max": data.twinkleSpeed.max,
                    "min": data.twinkleSpeed.min,
                    "value": data.twinkleSpeed.value
                });

            }
        }

        //we want the document to load before we start doing stuff
        //the fetch information will almost always take longer then document
        //load so in the future I might compare speeds with it in and out of document load.
        $(document).ready(function () {
            let lights = new LightControl();
            lights.fetchInformation(doneLoading);

            $('input').change(function (object) {
                var tar = object.target;
                var objectID = tar.id;
                var objectValue = tar.value;
                switch (objectID) {
                    case 'on-off':
                        lights.togglePower(curJson.power.value);
                        break;
                    case 'autoplay-on-off':
                        lights.toggleAutoplay(curJson.autoplay.value);
                        break;
                    case 'brightness':
                        lights.setBrightness(objectValue);
                        break;
                    //hue should go here
                    case 'selected-leaf':
                        if (objectValue == 0) {
                            lights.setAllLeafs(1);
                        } else {
                            lights.setAllLeafs(0);
                            lights.setSelectedLeaf(objectValue);
                        }
                        break;
                    case 'pattern-speed':
                        lights.setSpeed(objectValue);
                        break;
                    case 'autoplay-duration':
                        lights.setAutoplayDuration(objectValue);
                        break;
                    case 'patten-cooling':
                        lights.setCooling(objectValue);
                        break;
                    case 'pattern-sparking':
                        lights.setSparking(objectValue);
                        break;
                    case 'pattern-twinkle-speed':
                        lights.setTwinkleSpeed(objectValue);
                        break;
                    case 'pattern-twinkle-density':
                        lights.setTwinkleDensity(objectValue);
                        break;
                }
                //TODO: this should probably be staggered. some sort of stack? pop off every 300ms
                lights.fetchInformation(doneLoading);
            });

            $('select').change(function (object) {
                var tar = object.target;
                var objectID = tar.id;
                var objectValue = tar.value;
                switch (objectID) {
                    case 'pattern':
                        if (objectValue == "twinkle") {
                            $('.twinkle-container').show();
                        } else {
                            $('.twinkle-container').hide();
                            if (objectValue == 27 || objectValue == 28) { //this is fire and water 
                                $('.fire-container').show();
                            } else {
                                $('.fire-container').hide();
                            }
                            lights.setPattern(objectValue);
                        }

                        break;
                    case 'twinkle-type':
                        lights.setPattern(objectValue);
                        break;
                    case 'palette':
                        lights.setPalette(objectValue);
                        break;
                }
            });

        });

    </script>


</body>

</html>